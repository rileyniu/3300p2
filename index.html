<html>
	<head>
		<title> djm453, xz293, hn263 </title>
		<meta charset="utf-8">
		<script src="https://d3js.org/d3.v4.min.js"></script>
		<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>
    	<link href="https://fonts.googleapis.com/css?family=Rajdhani|Rubik+Mono+One" rel="stylesheet">
		<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
		<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
		<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
		<style>

			@font-face {
				font-family: Druk;
				src: url(fonts/Druk-MediumItalic.woff);
			}

			.title{
				display:block;
				height:300px;
			}

			.panel{
				display:inline-block;
				height:300px;
				margin-left: 100px;
			}

            h1 {font-family: Druk, sans-serif;
                font-size: 70px;
                font-style: normal;
                font-variant: normal;
                font-weight: 160;
                display: flex;
                margin-top: 130px;
                margin-left: 130px;
                margin-bottom: 0px;
                color: 	#ffffff;

            }
            h2 {font-family: 'Rajdhani', sans-serif;
                font-size: 18px;
                font-style: normal;
                font-variant: normal;
                font-weight: 80;
                line-height: 18px;
                margin-left: 130px;
                color: #C1C1C1;
            }
            h3 {font-family: Druk, sans-serif;
                font-size: 50px;
                font-style: normal;
                font-variant: normal;
                font-weight: 160;
                display: flex;
                margin-top: 130px;
                margin-left: 130px;
                margin-bottom: 0px;
                color: 	#ffffff;
            }
            h4 {font-family: 'Rajdhani', sans-serif;
            	font-size: 14px;
            	font-style: normal;
            	font-variant: normal;
            	font-weight: 80;
            	line-height: 18px;
            	text-align: left;
            	padding-left: 35px;
            	color: #8C8C8B;
            }
			body {font-family: 'Rajdhani', sans-serif;
                text-anchor: 'middle';
                dominant-baseline: 'central';
                background: #000000;
            }
            .legendSize circle {
                fill: #CE7602;
                opacity: 0.2;
            }
            .legendSize text {
                font-size: 11px;
                fill: #8C8C8B;
            }
            .textstyle1 {
                font-family: 'Rajdhani', sans-serif;
                font-size: 18px;
                font-style: normal;
                color: 	#ffffff;
            }
            .textstyle2 {
                font-family: 'Rajdhani', sans-serif;
                font-size: 11px;
                font-style: normal;
                fill: #C1C1C1;
            }
            .textstyle3 {
                font-family: 'Rajdhani', sans-serif;
                font-size: 11px;
                font-style: italic;
                fill: #8C8C8B;
            }
            #footnotes {
                font-family: 'Rajdhani', sans-serif;
                font-size: 18px;
                font-style: normal;
                color: 	#ffffff;
            }
            a {
                text-decoration: none;
                color: 	#ffffff;
                font-weight: bolder;
            }
			#map {
					margin: auto;
					display: inline-block;
					margin-left: -70px;
			}
			.ui-draggable, .ui-droppable {
					background-position: top;
			}

			#panel {
				display: inline-block;
				overflow: visible;
				z-index: -1;
			}

			#slider-vertical {
				height:10px;
				width:1000px;
				margin: auto;
				vertical-align: top;
				background-color: rgba(43, 39, 39, 0.5);
				border-style: solid;
				border-color: rgb(188, 188, 188);
				border-width: 2px;
				border-radius: 10px;
			}

			/*Reference: http://bl.ocks.org/nitaku/6354551*/
			.flowline {
			  fill: none;
			  opacity: 0.5;
			  stroke-width: 4;
			  stroke-dasharray: 10, 4;
			 /* animation: flow 0.5s linear infinite;
			  -webkit-animation: flow 0.5s linear infinite;*/
			}

			.tagsName{
				font-family:  'Rajdhani', sans-serif;
                font-size: 45px;
                font-variant: normal;
                font-weight: italic;
                display: flex;
                margin-left: 100px;
                color: 	#ffffff;
			}

			.tags {
				fill: #C1C1C1;
				font-size: 16pt;
				font-family: 'Rajdhani', sans-serif;
				font-weight: bold;
			}

			@keyframes flow {
			  from {
			    stroke-dashoffset: 14;
			  }

			  to {
			    stroke-dashoffset: 0;
			  }
			}

			@-webkit-keyframes flow {
			  from {
			    stroke-dashoffset: 14;
			  }

			  to {
			    stroke-dashoffset: 0;
			  }
			}
		</style>
	</head>

	<body>
		<div class="title" style="text-align: left;">
			<h1>MAPPING GLOBAL<br>
			REFUGEE MOVEMENT THROUGH TIME</h1>
			<h2>Spring 2018<br> INFO/CS 3300 Project 2</h2>

		</div>

<p id=“project1”>
<div id="slider-vertical"></div><br>
<svg style="display: inline-block" height="600" width="200" id="panel">
	<text x="20" id="country" class = "tags" y="60" font-size="20pt" style="display: block; margin: auto;"></text>
	<text x="20" class = "tags" y="100">Arriving from:</text>
	<text x="20" class = "tags" y="300">Departing to:</text>
</svg>
</div>
<svg height="570" width="1060" id="map"> </svg>
<script>
$( function() {
		$( "#slider-vertical" ).slider({
			classes: {
    "ui-slider": "highlight"
  },
			range: "min",
			animate: "medium",
			min: 1995,
			max: 2016,
			value: 2000,
		})

.each(function() {
  var vals = 21;

  for (var i = 0; i <= vals ; i++) {
      var tick = $('<div class="tick ui-widget-content"></div>').css('position', 'absolute')
			.css('display', 'inline-block')
			.css('left', (i/vals*100-0.1) +  '%')
			.css('top', 100 +  '%')
			.css('width', '2px')
			.css('height', '16px')
			.css('color', 'white');
			$( "#slider-vertical" ).append(tick);
  }

	$( "#slider-vertical" ).append('<br>');
  // Space out values
  for (var i = 1995; i <= 2016; i+=2) {
    var el = $('<label>'+(i)+'</label>')
    .css('position', 'absolute')
		.css('text-align', 'center')
		.css('font-family','Rajdhani, sans-serif' )
		.css('color', "white")
		.css('left', ((i-1995)/vals*100-1.5)+'%').css("margin-top", "10px");

		$( "#slider-vertical" ).append(el);
  }

});
	$( "#slider-vertical" ).on("slidechange", function(event, ui) {
				endPos = ui.value;
				var svg = d3.select(map);
			  drawLines(endPos, true);
		});
	} );

var svg = d3.select(map);
var panelSvg = d3.select(panel);

var rawData;
var refugeeData;
var countries;
var countries;
var links = [];
var countries_listed = [];

var dur = 500;

d3.queue()
.defer(d3.json, "countryData.json")
.defer(d3.json, "refugeeData.json")
.await(callback);

var latitudeScale;
var longitudeScale;
var populationScale;
var color;
var speedScale;
var speed;
//
// $("#destCountry").hide();

var textScale = d3.scaleLinear()
	.domain([0, 10])
	.range([130, 450]);

//Get latitude of a country
function latFun(d){
		var info = countryData.filter(function(n){return n.country == d;});
		return info[0].latitude;
}

//Get longitude of a country
function longiFun(d){
			var info = countryData.filter(function(n){return n.country == d;});
			return info[0].longitude;
}

d3.selection.prototype.moveToFront = function() {
	return this.each(function(){
  	this.parentNode.appendChild(this);
  });
};

d3.selection.prototype.moveToBack = function() {
        return this.each(function() {
            var firstChild = this.parentNode.firstChild;
            if (firstChild) {
                this.parentNode.insertBefore(this, firstChild);
            }
        });
    };

function refreshCircles(update){
	var trans = 0;
	if(update){
		trans = dur;
	}

	var containedCountries = countryData.filter(function (d){
		return countries_listed.includes(d.country);
	});

	svg.selectAll("circle")
	.filter(c => countries_listed.includes(c.country))
	.attr("class", "used");

	svg.selectAll(".used").transition().duration(trans).style("fill", "#42f4bc")
	.style("opacity", 0.6);

	svg.selectAll("circle")
	.filter(c => !countries_listed.includes(c.country))
	.attr("class", "notUsed");

	var i = 0;
	$(".used").delay(trans)
        .queue(function() {
            $(this).remove();
						var circleData = containedCountries[i];
						svg.select("g").selectAll(".used"+i).data([circleData]).enter().append("circle")
						.on("mouseover", mouseOverCircle)
						.on("mouseout", mouseOutCircle)
						.attr("cx", function(d) {
							return longitudeScale(d.longitude)
						})
						.attr("cy", function(d) {
							return latitudeScale(d.latitude)
						})
						.attr("r", function(d) {
							return populationScale(d.population)
						})
						.style("fill", "#42f4bc").style("opacity", 0.6);
						i=i+1;
  });

	svg.selectAll(".notUsed")
	.filter(c => !countries_listed.includes(c.country))
	.transition().duration(trans)
	.style("fill", "#34CCFF")
	.style("opacity", 0.3);

}

//Function called when mouse hovers over circle
function mouseOverCircle(d) {
	var couns = []
	var toCountry = [];
	var fromCountry = [];
	//Makes all paths with destination country matching country hovered opaque.
	d3.selectAll("path").filter(function(p){
		var isConnected = false;
		if(p.source == d.country && !couns.includes(p.target)){
			couns.push(p.target);
			fromCountry.push({"connectedCountry": p.target, "refugeeNumber": p.number});
			isConnected = true;
		}
		if(p.target == d.country && !couns.includes(p.source)) {
			couns.push(p.source);
			toCountry.push({"connectedCountry": p.source, "refugeeNumber": p.number});
			isConnected = true;
		}
		return isConnected;
	})
	.transition().duration(dur)
	.style("opacity", 1.0);

	//Makes all origin countries connected to highlighted destination country opaque
	d3.selectAll("circle").filter(function(c){
		return couns.includes(c.country);
	}).transition().duration(dur).style("opacity", 0.9);

	//Makes all countries not connected to highlighted destination country less opaque
	d3.selectAll("circle").filter(function(c){
		return !couns.includes(c.country);
	}).transition().duration(dur).style("opacity", 0.1);

	//Makes highlighted country opaque
	d3.select(this).transition().duration(dur).style("opacity", 0.9);

	//Makes all paths not connected to highlighted country less opaque
	d3.selectAll("path").filter(function(p){
		if(p.source == d.country || p.target == d.country){
			return false;
		}
		else {
			return true;
		}
	})
	.transition().duration(dur)
	.style("opacity", 0.3);

	panelSvg.select("#country").text(d.country);
	panelSvg.select("#country").attr("visibility", "visible");

	toCountry = toCountry.sort(function(a,b){
		return a.refugeeNumber - b.refugeeNumber;
	});

	fromCountry = fromCountry.sort(function(a,b){
		return a.refugeeNumber - b.refugeeNumber;
	});

	var selection = panelSvg.selectAll("#origCountries").data(toCountry);

	selection.enter().append("text")
	.attr("class", "origCountry")
	.attr("font-family", "DejaVu Sans Mono, monospace")
	.attr("x", 30)
	.attr("y", function(d, i) { return textScale(i);})
	.style("fill", "#c1c1c1")
	.style("font-size", "13pt")
	.text(function(oc){
		return oc.connectedCountry+": "+oc.refugeeNumber+ " refugees";
	});

	var selection2 = panelSvg.selectAll("#destCountries").data(fromCountry);

	selection2.enter().append("text")
	.attr("class", "destCountry")
	.attr("font-family", "DejaVu Sans Mono, monospace")
	.attr("x", 30)
	.attr("y", function(d, i) { return textScale(i)+200;})
	.style("fill", "#c1c1c1")
	.style("font-size", "13pt")
	.text(function(oc){
		return oc.connectedCountry+": "+oc.refugeeNumber+ " refugees";
	});
}

//Function called when mouse hovers exists circle
function mouseOutCircle (d) {
	//Makes all circles original opacity
	svg.selectAll("circle").filter(c => !countries_listed.includes(c.country))
	.transition().duration(dur).style("opacity", 0.3);

	svg.selectAll("circle")
	.filter(c => countries_listed.includes(c.country)).transition().duration(dur)
	.style("opacity", 0.6);

	//Makes all paths original opacity
	d3.selectAll("path")
	.transition().duration(dur)
	.style("opacity", 0.8);

	// $("#destCountry").hide(dur);
	d3.select("#country").attr("visibility", "hidden");

	$(".origCountry").remove();
	$(".destCountry").remove();
}

function callback (error, rawCountry, rawRefugee) {
	refugeeData = rawRefugee;
  countryData = rawCountry.filter(function (c) {
		return c.latitude !== null && c.longitude !== null && c.population !== null;
	}).sort(function(a, b){
		return b.population - a.population;
	});

	countries = countryData.map(c => c.country);

	var longitudeExtent = d3.extent(countryData, function (d) {
		return d.longitude;
	});

	longitudeScale = d3.scaleLinear()
		.domain(longitudeExtent)
		.range([50, 1050]);

	var latitudeExtent = d3.extent(countryData, function (d) {
		return d.latitude;
	});

	latitudeScale = d3.scaleLinear()
		.domain(latitudeExtent)
		.range([550, 50]);

	var populationExtent = d3.extent(countryData, function (d) {
		return d.population;
	});

	populationScale = d3.scaleSqrt()
		.domain(populationExtent)
		.range([9, 75]);


	var circles = svg.append('g')
                .selectAll("circle").data(countryData);
		circles = circles.enter().append("circle")
			.merge(circles)
      .on("mouseover", mouseOverCircle)
			.on("mouseout", mouseOutCircle);

	circles.attr("cx", function(d) {
		return longitudeScale(d.longitude)
	});

	circles.attr("cy", function(d) {
		return latitudeScale(d.latitude)
	});

	circles.attr("r", function(d) {
		return populationScale(d.population)
	});

	circles.style("fill", "#34CCFF");

	circles.attr("pop", function(d){
		return d.population;
	})

	for (var i = 0; i < refugeeData.length; i++){
		 links.push({"year": refugeeData[i].year, "number":refugeeData[i].refugeeNumber, "source": refugeeData[i].originCountry, "target": refugeeData[i].destinationCountry});
	}
	drawLines(2000, false);
}

function getPath(pathObject){
	var sx = longitudeScale(longiFun(pathObject.source)),
			sy = latitudeScale(latFun(pathObject.source)),
			tx = longitudeScale(longiFun(pathObject.target)),
			ty = latitudeScale(latFun(pathObject.target));
	var dx = tx- sx,
			dy = ty - sy,
			dr = Math.sqrt(dx * dx + dy * dy);
	return "M" + sx + "," + sy + "A" + dr + "," + dr + " 0 0,1 " + tx + "," + ty;
}

function drawLines(year, update) {
	var nodelinks = links.filter(function(link){
			return link.year == year && link.source!= "Various/Unknown" && link.target !="Various/Unknown" &&
							link.number >10000 && countries.includes(link.source) && countries.includes(link.target);
	});

	nodelinks = nodelinks.sort(function(a, b){
		return a.number - b.number;
	}).reverse().slice(0, 20);

	var refugeeNumExtent = d3.extent(nodelinks, function (d) {
			return d.number;
	});

	var refugeeNumScale = d3.scaleSqrt()
			.domain(refugeeNumExtent)
			.range([1, 20]);

	color = d3.scaleLog()
	.domain(refugeeNumExtent)
	.range(["#ffffff","#7700ff"]);

	speedScale = d3.scaleSqrt()
		.domain(refugeeNumExtent)
		.range([2, 0.5])

	function speed (d) {
		var n =speedScale(d);
		return n + "s";
	}

	countries_listed = []
	if(update){
		svg.selectAll("path")
		.data(nodelinks).transition().duration(700)
		.attr('class', 'flowline')
		.attr("d", function(d) {
				countries_listed.push(d.source);
				countries_listed.push(d.target);
				return getPath(d);
		 });
	}
	else{
		svg.selectAll("path")
		.data(nodelinks)
		.enter().append("path")
		.attr('class', 'flowline')
		.attr("d", function(d) {
				countries_listed.push(d.source);
				countries_listed.push(d.target);
				return getPath(d);
		 })
		// .attr("stroke", "#756bb1")
		.attr("stroke", function(d) {
				return color(d.number);
		})
		.style("opacity", 0.7)
		.style("fill", "none")
		.style("stroke-width", 3)
		.style("animation-name", "flow")
		.style("animation-duration", function(d) {
				return speed(d.number);
		})
		.style("animation-timing-function", "linear")
		.style("animation-iteration-count", "infinite");
		//  -webkit-animation: flow 0.5s linear infinite;;
	}
	refreshCircles(update);
}

</script>
</p>

<div class="title" style="width:85%; height:100px; padding-bottom: 50px; display: inline-block;">
<div style="width: 25%; display: inline-block; height:100px; float: left;"><h3>DESCRIPTION</h3></div>
<div style="margin-left: 25%; height:100px; display: inline-block;">
<p class="textstyle1">
<br>In an effort to find out how have global refugee movement develped and changed throughout the history since
the end of the Cold War, we collected, filtered and mapped global refugee data to a interactive visualization of worldwide movements. ...?
</p>
</div>
</div>


<div class="title" style="width:85%; height:100px;">
<div style="width: 25%; display: inline-block; height:100px; float: left;"><h3>CREDITS</h3></div>
<div style="margin-left: 25%; height:100px; display: inline-block;">
<p id="footnotes">
<br>Population data was retreived from <a href="https://data.worldbank.org/indicator/SP.POP.TOTL">World Bank World Development Indicators (2016)</a> and <a href="https://esa.un.org/unpd/wpp/DataQuery/">UN Population Division, World Population Prospects (2016)</a>.
<br>Fonts used are <a href="https://fonts.google.com/specimen/Rubik+Mono+One">Rubik Mono One</a> by Hubert and Fischer and <a href="https://fonts.google.com/specimen/Rajdhani">Rajdhani</a> by Indian Type Foundry, from Google Fonts.
</p>
</div>
</div>
</body>
</html>
